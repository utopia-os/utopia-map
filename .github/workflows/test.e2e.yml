name: test:e2e

on: push

jobs:
  cypress-e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    outputs:
      tests-failed: ${{ steps.cypress-tests.outcome == 'failure' }}
      tests-outcome: ${{ steps.cypress-tests.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Set up Node.js
        uses: actions/setup-node@89d709d423dc495668cd762a18dd4a070611be3f # v5.0.0
        with:
          node-version-file: ./.tool-versions
          cache: 'npm'
          cache-dependency-path: |
            app/package-lock.json
            lib/package-lock.json
            cypress/package-lock.json

      - name: Build Library
        run: |
          npm ci
          npm run build
        working-directory: ./lib

      - name: Build Frontend
        run: |
          cp .env.dist .env
          sed -i '/VITE_DIRECTUS_ADMIN_ROLE=/c\VITE_DIRECTUS_ADMIN_ROLE=8141dee8-8e10-48d0-baf1-680aea271298' .env
          npm ci
          npm run build
        working-directory: ./app

      - name: Clean Database State
        run: |
          # Remove any existing database data to ensure fresh state
          sudo rm -rf ./data/database
          mkdir -p ./data/uploads
          sudo chmod 777 -R ./data

      - name: Build and start all Containers
        run: docker compose up -d

      - name: Wait for Directus to be Ready
        run: |
          echo "Waiting for Directus API to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:8055/server/health; do echo "Waiting for Directus..."; sleep 5; done'
          echo "Directus is ready!"

      - name: Seed Backend
        run: |
          mkdir -p ./data/uploads
          sudo chmod 777 -R ./data
          cd backend && ./seed.sh
        working-directory: ./

      - name: Wait for Application to be Ready
        run: |
          echo "Waiting for application to be ready..."
          timeout 300 bash -c 'until curl -f http://localhost:8080/login; do sleep 5; done'
          echo "Application is ready!"

      - name: Health Check
        run: |
          echo "Frontend health check:"
          curl -f http://localhost:8080/login || exit 1
          echo "Backend health check:"
          curl -f http://localhost:8055/server/health || exit 1

      - name: Install Cypress Dependencies
        run: npm ci
        working-directory: ./cypress

      - name: Setup Display Environment for Parallel Tests
        run: |
          echo "Setting up display environment for parallel Cypress execution..."

          # Kill any existing Xvfb processes to ensure clean state
          sudo pkill Xvfb || true

          # Remove any existing lock files
          sudo rm -f /tmp/.X*-lock || true

          # Ensure xvfb is available
          which xvfb-run || (sudo apt-get update && sudo apt-get install -y xvfb)

          # Create a wrapper script for parallel execution with display isolation
          cat > /tmp/cypress-parallel-wrapper.sh << 'EOF'
          #!/bin/bash

          # Get parameters
          SPEC_COUNT="$1"
          SPLIT_INDEX="$2"

          # Calculate unique display number starting from 100 to avoid conflicts with :99
          DISPLAY_NUM=$((100 + SPLIT_INDEX))

          echo "Running Cypress chunk $((SPLIT_INDEX + 1))/$SPEC_COUNT on display :$DISPLAY_NUM"

          # Run Cypress with isolated display using xvfb-run
          SPLIT="$SPEC_COUNT" SPLIT_INDEX="$SPLIT_INDEX" \
          xvfb-run --server-num="$DISPLAY_NUM" \
                   --server-args="-screen 0 1280x720x24 -ac +extension GLX +render -noreset" \
                   cypress run --e2e --browser chromium
          EOF

          chmod +x /tmp/cypress-parallel-wrapper.sh

          echo "Display environment setup complete"

      - name: Run E2E Tests
        id: cypress-tests
        continue-on-error: true
        run: |
          SPEC_COUNT=$(find e2e -name "*.cy.ts" | wc -l)
          echo "Running $SPEC_COUNT test chunks in parallel with display isolation"

          # Launch parallel processes with isolated displays
          for i in $(seq 0 $((SPEC_COUNT-1))); do
            /tmp/cypress-parallel-wrapper.sh "$SPEC_COUNT" "$i" &
          done

          # Wait for all background processes to complete
          wait

          echo "All parallel test processes completed"
        working-directory: ./cypress
        env:
          # Disable individual cypress-split summaries to avoid conflicts
          SPLIT_SUMMARY: false

      - name: Merge Test Reports
        if: always()
        run: |
          if [ -d "reports/json" ] && [ "$(ls -A reports/json)" ]; then
            npm run report:merge
          else
            echo "No test reports to merge"
          fi
        working-directory: ./cypress

      - name: Generate HTML Report
        if: always()
        run: |
          if [ -f "reports/json/merged-report.json" ]; then
            npm run report:generate
          else
            echo "No merged report to generate HTML from"
          fi
        working-directory: ./cypress

      - name: Create Test Summary
        if: always()
        run: |
          echo "# Cypress E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count total specs
          TOTAL_SPECS=$(find e2e -name "*.cy.ts" | wc -l)
          echo "**Total Specs:** $TOTAL_SPECS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if tests passed or failed
          if [ "${{ steps.cypress-tests.outcome }}" = "success" ]; then
            echo "## ‚úÖ All Tests Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Always show spec details table
          echo "## üìä Test Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Spec File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # List all spec files and their status
          find e2e -name "*.cy.ts" | sort | while read spec; do
            spec_name=$(basename "$spec")
            if [ "${{ steps.cypress-tests.outcome }}" = "success" ]; then
              echo "| $spec_name | ‚úÖ Executed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $spec_name | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Add test counts from JSON reports if available
          if [ -d "reports/json" ] && [ "$(ls -A reports/json 2>/dev/null)" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üìà Test Counts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            TOTAL_TESTS=0
            PASSED_TESTS=0
            FAILED_TESTS=0

            # Parse JSON reports to get test counts
            for json_file in reports/json/*.json; do
              if [ -f "$json_file" ]; then
                # Extract test counts using basic tools (avoiding jq dependency)
                TESTS=$(grep -o '"tests":[0-9]*' "$json_file" | cut -d':' -f2 || echo "0")
                PASSES=$(grep -o '"passes":[0-9]*' "$json_file" | cut -d':' -f2 || echo "0")
                FAILURES=$(grep -o '"failures":[0-9]*' "$json_file" | cut -d':' -f2 || echo "0")

                TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                PASSED_TESTS=$((PASSED_TESTS + PASSES))
                FAILED_TESTS=$((FAILED_TESTS + FAILURES))
              fi
            done

            echo "- **Total Tests:** $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed:** $PASSED_TESTS ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed:** $FAILED_TESTS ‚ùå" >> $GITHUB_STEP_SUMMARY
          fi

          # Add links to artifacts
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Reports" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.cypress-tests.outcome }}" = "failure" ]; then
            echo "- HTML Report: Will be available in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Screenshots: Will be available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ All tests passed - no artifacts needed" >> $GITHUB_STEP_SUMMARY
          fi
        working-directory: ./cypress

      - name: Upload Test Artifacts (Temporary)
        if: always() && steps.cypress-tests.outcome == 'failure'
        uses: actions/upload-artifact@2848b2cda0e5190984587ec6bb1f36730ca78d50 # v4.6.2
        with:
          name: e2e-test-reports-temp-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            cypress/reports/
          retention-days: 1
          if-no-files-found: warn

      - name: Report Test Results
        if: always()
        run: |
          if [ "${{ steps.cypress-tests.outcome }}" = "failure" ]; then
            echo "‚ùå Tests failed - artifacts will be uploaded by dependent job"
            exit 1
          else
            echo "‚úÖ All tests passed successfully"
          fi

  upload-artifacts:
    name: Upload Test Artifacts
    runs-on: ubuntu-latest
    needs: cypress-e2e-tests
    # Only run if the test job failed (not cancelled or skipped)
    if: always() && needs.cypress-e2e-tests.result == 'failure'
    steps:
      - name: Download Test Reports
        uses: actions/download-artifact@4a24838f3d5601fd639834081e118c2995d51e1c #v5.0.0
        with:
          name: e2e-test-reports-temp-${{ github.run_id }}-${{ github.run_attempt }}
          path: ./cypress-reports

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@2848b2cda0e5190984587ec6bb1f36730ca78d50 # v4.6.2
        with:
          name: e2e-test-failures-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            cypress-reports/reports/screenshots
            cypress-reports/reports/html
            cypress-reports/reports/json
          retention-days: 30
          if-no-files-found: warn

      - name: Create Failure Summary
        run: |
          echo "# üö® E2E Test Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The E2E tests failed. Artifacts have been uploaded for analysis." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Screenshots**: Visual evidence of failed tests" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Report**: Detailed test results with interactive features" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON Reports**: Raw test data for further analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Open the HTML report to see detailed test results" >> $GITHUB_STEP_SUMMARY
          echo "3. Review screenshots to understand visual failures" >> $GITHUB_STEP_SUMMARY
          echo "4. Check the test logs in the main job for additional context" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup Temporary Artifacts
        if: always()
        continue-on-error: true
        run: |
          # Note: GitHub Actions will automatically clean up temporary artifacts
          # This step is mainly for documentation purposes
          echo "Temporary artifacts will be automatically cleaned up by GitHub Actions"